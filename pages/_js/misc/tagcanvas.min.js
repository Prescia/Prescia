/**
 * Copyright (C) 2010-2012 Graham Breach
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
/**
 * TagCanvas 2.0
 * For more information, please contact <graham@goat1000.com>
 */
(function(){var af,ae,T=Math.abs,u=Math.sin,k=Math.cos,F=Math.max,aj=Math.min,P=Math.ceil,H={},J={},N={0:"0,",1:"17,",2:"34,",3:"51,",4:"68,",5:"85,",6:"102,",7:"119,",8:"136,",9:"153,",a:"170,",A:"170,",b:"187,",B:"187,",c:"204,",C:"204,",d:"221,",D:"221,",e:"238,",E:"238,",f:"255,",F:"255,"},d,W,c,n=document,E,b={};for(af=0;af<256;++af){ae=af.toString(16);if(af<16){ae="0"+ae}J[ae]=J[ae.toUpperCase()]=af.toString()+","}function aa(i){return typeof(i)!="undefined"}function a(i,j,al){return isNaN(i)?al:aj(al,F(j,i))}function R(){return false}function m(al,ao){var j=[],am=al.length,an;for(an=0;an<am;++an){j.push(al[an])}j.sort(ao);return j}function V(j){var am=j.length-1,al,an;while(am){an=~~(Math.random()*am);al=j[am];j[am]=j[an];j[an]=al;--am}}function g(i){this[1]={1:i[0],2:i[1],3:i[2],4:i[3]};this[2]={1:i[4],2:i[5],3:i[6],4:i[7]};this[3]={1:i[8],2:i[9],3:i[10],4:i[11]};this[4]={1:i[12],2:i[13],3:i[14],4:i[15]}}g.Identity=function(){return new g([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])};g.prototype.mul=function(al){var am=[],ao,an;for(ao=1;ao<=4;++ao){for(an=1;an<=4;++an){am.push(this[ao][1]*al[1][an]+this[ao][2]*al[2][an]+this[ao][3]*al[3][an]+this[ao][4]*al[4][an])}}return new g(am)};g.prototype.xform=function(am){var al={},i=am.x,ao=am.y,an=am.z,j=aa(am.w)?am.w:1;al.x=i*this[1][1]+ao*this[2][1]+an*this[3][1]+j*this[4][1];al.y=i*this[1][2]+ao*this[2][2]+an*this[3][2]+j*this[4][2];al.z=i*this[1][3]+ao*this[2][3]+an*this[3][3]+j*this[4][3];al.w=i*this[1][4]+ao*this[2][4]+an*this[3][4]+j*this[4][4];return al};function r(am,ao,au,aq){var ap,at,j,ar,av=[],an=Math.PI*(3-Math.sqrt(5)),al=2/am;for(ap=0;ap<am;++ap){at=ap*al-1+(al/2);j=Math.sqrt(1-at*at);ar=ap*an;av.push([k(ar)*j*ao,at*au,u(ar)*j*aq])}return av}function ai(an,al,aq,ax,av){var aw,ay=[],ao=Math.PI*(3-Math.sqrt(5)),am=2/an,au,at,ar,ap;for(au=0;au<an;++au){at=au*am-1+(am/2);aw=au*ao;ar=k(aw);ap=u(aw);ay.push(al?[at*aq,ar*ax,ap*av]:[ar*aq,at*ax,ap*av])}return ay}function M(al,am,ap,aw,au,ar){var av,ax=[],an=Math.PI*2/am,at,aq,ao;for(at=0;at<am;++at){av=at*an;aq=k(av);ao=u(av);ax.push(al?[ar*ap,aq*aw,ao*au]:[aq*ap,ar*aw,ao*au])}return ax}function B(am,i,j,al){return ai(am,0,i,j,al)}function Q(am,i,j,al){return ai(am,1,i,j,al)}function z(an,i,j,al,am){am=isNaN(am)?0:am*1;return M(0,an,i,j,al,am)}function K(an,i,j,al,am){am=isNaN(am)?0:am*1;return M(1,an,i,j,al,am)}function t(ao,i){var an=ao,am,al,j=(i*1).toPrecision(3)+")";if(ao[0]==="#"){if(!H[ao]){if(ao.length===4){H[ao]="rgba("+N[ao[1]]+N[ao[2]]+N[ao[3]]}else{H[ao]="rgba("+J[ao.substr(1,2)]+J[ao.substr(3,2)]+J[ao.substr(5,2)]}}an=H[ao]+j}else{if(ao.substr(0,4)==="rgb("||ao.substr(0,4)==="hsl("){an=(ao.replace("(","a(").replace(")",","+j))}else{if(ao.substr(0,5)==="rgba("||ao.substr(0,5)==="hsla("){am=ao.lastIndexOf(",")+1,al=ao.indexOf(")");i*=parseFloat(ao.substring(am,al));an=ao.substr(0,am)+i.toPrecision(3)+")"}}}return an}function h(i,j){if(window.G_vmlCanvasManager){return null}var al=n.createElement("canvas");al.width=i;al.height=j;return al}function A(){var j=h(3,3),am,al;if(!j){return false}am=j.getContext("2d");am.strokeStyle="#000";am.shadowColor="#fff";am.shadowBlur=3;am.globalAlpha=0;am.strokeRect(2,2,2,2);am.globalAlpha=1;al=am.getImageData(2,2,1,1);j=null;return(al.data[0]>0)}function ak(at,j){var al=1024,ao=at.weightGradient,an,aq,am,ar,ap;if(at.gCanvas){aq=at.gCanvas.getContext("2d")}else{at.gCanvas=an=h(al,1);if(!an){return null}aq=an.getContext("2d");ar=aq.createLinearGradient(0,0,al,0);for(am in ao){ar.addColorStop(1-am,ao[am])}aq.fillStyle=ar;aq.fillRect(0,0,al,1)}ap=aq.getImageData(~~((al-1)*j),0,1,1).data;return"rgba("+ap[0]+","+ap[1]+","+ap[2]+","+(ap[3]/255)+")"}function y(aq,ap,am,ax,ar,at,al,au,av){var ao=(at||0)+(al&&al[0]<0?T(al[0]):0),j=(at||0)+(al&&al[1]<0?T(al[1]):0),an,aw;aq.font=ap;aq.textBaseline="top";aq.fillStyle=am;ar&&(aq.shadowColor=ar);at&&(aq.shadowBlur=at);al&&(aq.shadowOffsetX=al[0],aq.shadowOffsetY=al[1]);for(an=0;an<ax.length;++an){aw=av?(au-av[an])/2:0;aq.fillText(ax[an],ao+aw,j);j+=parseInt(ap)}}function p(aA,aq,aw,ay,ap,am,au,av,j,az,ax,at,al){var an=ay+T(j[0])+av+av,i=ap+T(j[1])+av+av,ao,ar;ao=h(an+az,i+ax);if(!ao){return null}ar=ao.getContext("2d");y(ar,aq,am,aA,au,av,j,at,al);return ao}function ad(aq,au,av,am){var aw=T(am[0]),ar=T(am[1]),an=aq.width+(aw>av?aw+av:av*2),j=aq.height+(ar>av?ar+av:av*2),ap=(av||0)+(am[0]<0?aw:0),al=(av||0)+(am[1]<0?ar:0),ao,at;ao=h(an,j);if(!ao){return null}at=ao.getContext("2d");au&&(at.shadowColor=au);av&&(at.shadowBlur=av);am&&(at.shadowOffsetX=am[0],at.shadowOffsetY=am[1]);at.drawImage(aq,ap,al,aq.width,aq.height);return ao}function X(ay,ap,aw){var ax=parseInt(ay.toString().length*aw),ao=parseInt(aw*2*ay.length),am=h(ax,ao),at,j,an,ar,av,au,al,aq;if(!am){return null}at=am.getContext("2d");at.fillStyle="#000";at.fillRect(0,0,ax,ao);y(at,aw+"px "+ap,"#fff",ay,0,0,[]);j=at.getImageData(0,0,ax,ao);an=j.width;ar=j.height;aq={min:{x:an,y:ar},max:{x:-1,y:-1}};for(au=0;au<ar;++au){for(av=0;av<an;++av){al=(au*an+av)*4;if(j.data[al+1]>0){if(av<aq.min.x){aq.min.x=av}if(av>aq.max.x){aq.max.x=av}if(au<aq.min.y){aq.min.y=au}if(au>aq.max.y){aq.max.y=au}}}}if(an!=ax){aq.min.x*=(ax/an);aq.max.x*=(ax/an)}if(ar!=ao){aq.min.y*=(ax/ar);aq.max.y*=(ax/ar)}am=null;return aq}function w(i){return"'"+i.replace(/(\'|\")/g,"").replace(/\s*,\s*/g,"', '")+"'"}function D(i,j,al){al=al||n;if(al.addEventListener){al.addEventListener(i,j,false)}else{al.attachEvent("on"+i,j)}}function ac(an,ap,am,al){var ao=al.imageScale,j;if(!ap.complete){return D("load",function(){ac(an,ap,am,al)},ap)}if(!an.complete){return D("load",function(){ac(an,ap,am,al)},an)}ap.width=ap.width;ap.height=ap.height;if(ao){an.width=ap.width*ao;an.height=ap.height*ao}am.w=an.width;am.h=an.height;if(al.txtOpt&&al.shadow){j=ad(an,al.shadow,al.shadowBlur,al.shadowOffset);if(j){am.image=j;am.w=j.width;am.h=j.height}}}function Z(am,al){var j=n.defaultView,i=al.replace(/\-([a-z])/g,function(an){return an.charAt(1).toUpperCase()});return(j&&j.getComputedStyle&&j.getComputedStyle(am,null).getPropertyValue(al))||(am.currentStyle&&am.currentStyle[i])}function C(al,j){var i=1,am;if(al.weightFrom){i=1*(j.getAttribute(al.weightFrom)||al.textHeight)}else{if(am=Z(j,"font-size")){i=(am.indexOf("px")>-1&&am.replace("px","")*1)||(am.indexOf("pt")>-1&&am.replace("pt","")*1.25)||am*3.3}else{al.weight=false}}return i}function x(i){return i.target&&aa(i.target.id)?i.target.id:i.srcElement.parentNode.id}function I(j,al){if(aa(j.offsetX)){return{x:j.offsetX,y:j.offsetY}}else{var i=q(al);if(aa(j.changedTouches)){j=j.changedTouches[0]}if(j.pageX){return{x:j.pageX-i.x,y:j.pageY-i.y}}}return null}function l(al){var j=al.target||al.fromElement.parentNode,i=v.tc[j.id];if(i){i.mx=i.my=-1;i.UnFreeze();i.EndDrag()}}function Y(ap){var am,al=v,j,ao,an=x(ap);for(am in al.tc){j=al.tc[am];if(j.tttimer){clearTimeout(j.tttimer);j.tttimer=null}}if(an&&al.tc[an]){j=al.tc[an];if(ao=I(ap,an)){j.mx=ao.x;j.my=ao.y;j.Drag(ap,ao)}j.drawn=0}}function S(am){var j=v,i=n.addEventListener?0:1,al=x(am);if(al&&am.button==i&&j.tc[al]){j.tc[al].BeginDrag(am)}}function f(an){var al=v,j=n.addEventListener?0:1,am=x(an),i;if(am&&an.button==j&&al.tc[am]){i=al.tc[am];Y(an);if(!i.EndDrag()&&!i.touched){i.Clicked(an)}}}function G(al){var i=v,j=x(al);if(j&&al.changedTouches&&i.tc[j]){i.tc[j].touched=1;i.tc[j].BeginDrag(al)}}function o(al){var i=v,j=x(al);if(j&&al.changedTouches&&i.tc[j]){U(al);if(!i.tc[j].EndDrag()){i.tc[j].Draw();i.tc[j].Clicked(al)}}}function U(ap){var am,al=v,j,ao,an=x(ap);for(am in al.tc){j=al.tc[am];if(j.tttimer){clearTimeout(j.tttimer);j.tttimer=null}}if(an&&al.tc[an]&&ap.changedTouches){j=al.tc[an];if(ao=I(ap,an)){j.mx=ao.x;j.my=ao.y;j.Drag(ap,ao)}j.drawn=0}}function ah(al){var i=v,j=x(al);if(j&&i.tc[j]){al.cancelBubble=true;al.returnValue=false;al.preventDefault&&al.preventDefault();i.tc[j].Wheel((al.wheelDelta||al.detail)>0)}}function s(an){var j=v.tc,am,al;an=an||new Date().valueOf();for(am in j){al=j[am].interval;j[am].Draw(an)}v.NextFrame(al)}function q(al){var ao=n.getElementById(al),i=ao.getBoundingClientRect(),ar=n.documentElement,ap=n.body,aq=window,am=aq.pageXOffset||ar.scrollLeft,at=aq.pageYOffset||ar.scrollTop,an=ar.clientLeft||ap.clientLeft,j=ar.clientTop||ap.clientTop;return{x:i.left+am-an,y:i.top+at-j}}function ag(j,am,an,al){var i=j.radius*j.z1/(j.z1+j.z2+am.z);return{x:am.x*i*an,y:am.y*i*al,z:am.z,w:(j.z1-am.z)/j.z2}}function L(i){this.e=i;this.br=0;this.line=[];this.text=[];this.original=i.innerText||i.textContent}L.prototype.Lines=function(an){var am=an?1:0,ao,j,al;an=an||this.e;ao=an.childNodes;j=ao.length;for(al=0;al<j;++al){if(ao[al].nodeName=="BR"){this.text.push(this.line.join(" "));this.br=1}else{if(ao[al].nodeType==3){if(this.br){this.line=[ao[al].nodeValue];this.br=0}else{this.line.push(ao[al].nodeValue)}}else{this.Lines(ao[al])}}}am||this.br||this.text.push(this.line.join(" "));return this.text};L.prototype.SplitWidth=function(al,at,ap,ao){var an,am,ar,aq=[];at.font=ao+"px "+ap;for(an=0;an<this.text.length;++an){ar=this.text[an].split(/\s+/);this.line=[ar[0]];for(am=1;am<ar.length;++am){if(at.measureText(this.line.join(" ")+" "+ar[am]).width>al){aq.push(this.line.join(" "));this.line=[ar[am]]}else{this.line.push(ar[am])}}aq.push(this.line.join(" "))}return this.text=aq};function e(i){this.ts=new Date().valueOf();this.tc=i;this.x=this.y=this.w=this.h=this.sc=1;this.z=0;this.Draw=i.pulsateTo<1&&i.outlineMethod!="colour"?this.DrawPulsate:this.DrawSimple;this.SetMethod(i.outlineMethod)}d=e.prototype;d.SetMethod=function(al){var j={block:["PreDraw","DrawBlock"],colour:["PreDraw","DrawColour"],outline:["PostDraw","DrawOutline"],classic:["LastDraw","DrawOutline"],none:["LastDraw"]},i=j[al]||j.outline;if(al=="none"){this.Draw=function(){return 1}}else{this.drawFunc=this[i[1]]}this[i[0]]=this.Draw};d.Update=function(ar,aq,at,an,ao,ap,am,i){var j=this.tc.outlineOffset,al=2*j;this.x=ao*ar+am-j;this.y=ao*aq+i-j;this.w=ao*at+al;this.h=ao*an+al;this.sc=ao;this.z=ap};d.DrawOutline=function(ao,i,an,j,al,am){ao.strokeStyle=am;ao.strokeRect(i,an,j,al)};d.DrawColour=function(am,ap,an,aq,al,i,ar,j,ao){return this[ar.image?"DrawColourImage":"DrawColourText"](am,ap,an,aq,al,i,ar,j,ao)};d.DrawColourText=function(an,aq,ao,ar,al,i,at,j,ap){var am=at.colour;at.colour=i;at.alpha=1;at.Draw(an,j,ap);at.colour=am;return 1};d.DrawColourImage=function(aq,au,ar,av,ap,i,ay,j,at){var aw=aq.canvas,an=~~F(au,0),am=~~F(ar,0),ao=aj(aw.width-an,av)+0.5|0,ax=aj(aw.height-am,ap)+0.5|0,al;if(E){E.width=ao,E.height=ax}else{E=h(ao,ax)}if(!E){return this.SetMethod("outline")}al=E.getContext("2d");al.drawImage(aw,an,am,ao,ax,0,0,ao,ax);aq.clearRect(an,am,ao,ax);ay.alpha=1;ay.Draw(aq,j,at);aq.setTransform(1,0,0,1,0,0);aq.save();aq.beginPath();aq.rect(an,am,ao,ax);aq.clip();aq.globalCompositeOperation="source-in";aq.fillStyle=i;aq.fillRect(an,am,ao,ax);aq.restore();aq.globalCompositeOperation="destination-over";aq.drawImage(E,0,0,ao,ax,an,am,ao,ax);aq.globalCompositeOperation="source-over";return 1};d.DrawBlock=function(ao,i,an,j,al,am){ao.fillStyle=am;ao.fillRect(i,an,j,al)};d.DrawSimple=function(an,i,j,am){var al=this.tc;an.setTransform(1,0,0,1,0,0);an.strokeStyle=al.outlineColour;an.lineWidth=al.outlineThickness;an.shadowBlur=an.shadowOffsetX=an.shadowOffsetY=0;an.globalAlpha=1;return this.drawFunc(an,this.x,this.y,this.w,this.h,al.outlineColour,i,j,am)};d.DrawPulsate=function(ao,i,j,am){var an=new Date().valueOf()-this.ts,al=this.tc;ao.setTransform(1,0,0,1,0,0);ao.strokeStyle=al.outlineColour;ao.lineWidth=al.outlineThickness;ao.shadowBlur=ao.shadowOffsetX=ao.shadowOffsetY=0;ao.globalAlpha=al.pulsateTo+((1-al.pulsateTo)*(0.5+(k(2*Math.PI*an/(1000*al.pulsateTime))/2)));return this.drawFunc(ao,this.x,this.y,this.w,this.h,al.outlineColour,i,j,am)};d.Active=function(al,i,j){return(i>=this.x&&j>=this.y&&i<=this.x+this.w&&j<=this.y+this.h)};d.PreDraw=d.PostDraw=d.LastDraw=R;function O(am,at,ap,ar,aq,an,j,al,i){var ao=am.ctxt;this.tc=am;this.image=at.src?at:null;this.text=at.src?[]:at;this.text_original=i;this.line_widths=[];this.title=ap.title||null;this.a=ap;this.position={x:ar[0],y:ar[1],z:ar[2]};this.x=this.y=this.z=0;this.w=aq;this.h=an;this.colour=j||am.textColour;this.textFont=al||am.textFont;this.weight=this.sc=this.alpha=1;this.weighted=!am.weight;this.outline=new e(am);if(!this.image){this.textHeight=am.textHeight;this.extents=X(this.text,this.textFont,this.textHeight);this.Measure(ao,am)}this.SetShadowColour=am.shadowAlpha?this.SetShadowColourAlpha:this.SetShadowColourFixed;this.SetDraw(am)}W=O.prototype;W.EqualTo=function(al){var j=al.getElementsByTagName("img");if(this.a.href!=al.href){return 0}if(j.length){return this.image.src==j[0].src}return(al.innerText||al.textContent)==this.text_original};W.SetDraw=function(i){this.Draw=this.image?(i.ie>7?this.DrawImageIE:this.DrawImage):this.DrawText;i.noSelect&&(this.CheckActive=R)};W.MeasureText=function(ao){var am,al=this.text.length,j=0,an;for(am=0;am<al;++am){this.line_widths[am]=an=ao.measureText(this.text[am]).width;j=F(j,an)}return j};W.Measure=function(ap,j){this.h=this.extents?this.extents.max.y+this.extents.min.y:this.textHeight;ap.font=this.font=this.textHeight+"px "+this.textFont;this.w=this.MeasureText(ap);if(j.txtOpt){var am=j.txtScale,an=am*this.textHeight,ao=an+"px "+this.textFont,al=[am*j.shadowOffset[0],am*j.shadowOffset[1]],i;ap.font=ao;i=this.MeasureText(ap);this.image=p(this.text,ao,an,i,am*this.h,this.colour,j.shadow,am*j.shadowBlur,al,am,am,i,this.line_widths);if(this.image){this.w=this.image.width/am;this.h=this.image.height/am}this.SetDraw(j);j.txtOpt=!!this.image}};W.SetFont=function(i,j){this.textFont=i;this.colour=j;this.extents=X(this.text,this.textFont,this.textHeight);this.Measure(this.tc.ctxt,this.tc)};W.SetWeight=function(i){if(!this.text.length){return}this.weight=i;this.Weight(this.tc.ctxt,this.tc);this.Measure(this.tc.ctxt,this.tc)};W.Weight=function(am,al){var j=this.weight,i=al.weightMode;this.weighted=true;if(i=="colour"||i=="both"){this.colour=ak(al,(j-al.min_weight)/(al.max_weight-al.min_weight))}if(i=="size"||i=="both"){if(al.weightSizeMin>0&&al.weightSizeMax>al.weightSizeMin){this.textHeight=al.weightSize*(al.weightSizeMin+(al.weightSizeMax-al.weightSizeMin)*(j-al.min_weight)/(al.max_weight-al.min_weight))}else{this.textHeight=j*al.weightSize}}this.extents=X(this.text,this.textFont,this.textHeight)};W.SetShadowColourFixed=function(al,j,i){al.shadowColor=j};W.SetShadowColourAlpha=function(al,j,i){al.shadowColor=t(j,i)};W.DrawText=function(an,aq,am){var ar=this.tc,ap=this.x,ao=this.y,at=this.sc,j,al;an.globalAlpha=this.alpha;an.fillStyle=this.colour;ar.shadow&&this.SetShadowColour(an,ar.shadow,this.alpha);an.font=this.font;ap+=aq/at;ao+=(am/at)-(this.h/2);for(j=0;j<this.text.length;++j){al=ap-(this.line_widths[j]/2);an.setTransform(at,0,0,at,at*al,at*ao);an.fillText(this.text[j],0,0);ao+=this.textHeight}};W.DrawImage=function(an,au,am){var aq=this.x,ao=this.y,av=this.sc,j=this.image,ar=this.w,al=this.h,ap=this.alpha,at=this.shadow;an.globalAlpha=ap;at&&this.SetShadowColour(an,at,ap);aq+=(au/av)-(ar/2);ao+=(am/av)-(al/2);an.setTransform(av,0,0,av,av*aq,av*ao);an.drawImage(j,0,0,ar,al)};W.DrawImageIE=function(an,ar,am){var j=this.image,at=this.sc,aq=j.width=this.w*at,al=j.height=this.h*at,ap=(this.x*at)+ar-(aq/2),ao=(this.y*at)+am-(al/2);an.setTransform(1,0,0,1,0,0);an.globalAlpha=this.alpha;an.drawImage(j,ap,ao)};W.Calc=function(i){var j,an=this.tc,am=an.minBrightness,al=an.maxBrightness,ao=an.max_radius;j=i.xform(this.position);j=ag(an,j,an.stretchX,an.stretchY);this.x=j.x;this.y=j.y;this.z=j.z;this.sc=j.w;this.alpha=a(am+(al-am)*(ao-this.z)/(2*ao),0,1)};W.CheckActive=function(am,aq,al){var ar=this.tc,i=this.outline,ap=this.w,j=this.h,ao=this.x-ap/2,an=this.y-j/2;i.Update(ao,an,ap,j,this.sc,this.z,aq,al);return i.Active(am,ar.mx,ar.my)?i:null};W.Clicked=function(ao){var j=this.a,al=j.target,am=j.href,i;if(al!=""&&al!="_self"){if(self.frames[al]){self.frames[al].document.location=am}else{try{if(top.frames[al]){top.frames[al].document.location=am;return}}catch(an){}window.open(am,al)}return}if(n.createEvent){i=n.createEvent("MouseEvents");i.initMouseEvent("click",1,1,window,0,0,0,0,0,0,0,0,0,0,null);if(!j.dispatchEvent(i)){return}}else{if(j.fireEvent){if(!j.fireEvent("onclick")){return}}}n.location=am};function v(aq,j,am){var al,ao,ap=n.getElementById(aq),an=["id","class","innerHTML"];if(!ap){throw 0}if(aa(window.G_vmlCanvasManager)){ap=window.G_vmlCanvasManager.initElement(ap);this.ie=parseFloat(navigator.appVersion.split("MSIE")[1])}if(ap&&(!ap.getContext||!ap.getContext("2d").fillText)){ao=n.createElement("DIV");for(al=0;al<an.length;++al){ao[an[al]]=ap[an[al]]}ap.parentNode.insertBefore(ao,ap);ap.parentNode.removeChild(ap);throw 0}for(al in v.options){this[al]=am&&aa(am[al])?am[al]:(aa(v[al])?v[al]:v.options[al])}this.canvas=ap;this.ctxt=ap.getContext("2d");this.z1=250/this.depth;this.z2=this.z1/this.zoom;this.radius=aj(ap.height,ap.width)*0.0075;this.max_weight=0;this.min_weight=200;this.textFont=this.textFont&&w(this.textFont);this.textHeight*=1;this.pulsateTo=a(this.pulsateTo,0,1);this.minBrightness=a(this.minBrightness,0,1);this.maxBrightness=a(this.maxBrightness,this.minBrightness,1);this.ctxt.textBaseline="top";this.lx=(this.lock+"").indexOf("x")+1;this.ly=(this.lock+"").indexOf("y")+1;this.frozen=0;this.dx=this.dy=0;this.touched=0;this.source=n.getElementById(j||aq);this.transform=g.Identity();this.time=new Date().valueOf();this.Animate=this.dragControl?this.AnimateDrag:this.AnimatePosition;if(this.shadowBlur||this.shadowOffset[0]||this.shadowOffset[1]){this.ctxt.shadowColor=this.shadow;this.shadow=this.ctxt.shadowColor;this.shadowAlpha=A()}else{delete this.shadow}this.Load();if(j&&this.hideTags){(function(i){if(v.loaded){i.source.style.display="none"}else{D("load",function(){i.source.style.display="none"},window)}})(this)}this.yaw=this.initial?this.initial[0]*this.maxSpeed:0;this.pitch=this.initial?this.initial[1]*this.maxSpeed:0;if(this.tooltip){if(this.tooltip=="native"){this.Tooltip=this.TooltipNative}else{this.Tooltip=this.TooltipDiv;if(!this.ttdiv){this.ttdiv=n.createElement("div");this.ttdiv.className=this.tooltipClass;this.ttdiv.style.position="absolute";this.ttdiv.style.zIndex=ap.style.zIndex+1;D("mouseover",function(i){i.target.style.display="none"},this.ttdiv);n.body.appendChild(this.ttdiv)}}}else{this.Tooltip=this.TooltipNone}if(!this.noMouse&&!b[aq]){D("mousemove",Y,ap);D("mouseout",l,ap);D("mouseup",f,ap);D("touchstart",G,ap);D("touchend",o,ap);D("touchcancel",o,ap);D("touchmove",U,ap);if(this.dragControl){D("mousedown",S,ap);D("selectstart",R,ap)}if(this.wheelZoom){D("mousewheel",ah,ap);D("DOMMouseScroll",ah,ap)}b[aq]=1}v.started||(v.started=setTimeout(s,this.interval))}c=v.prototype;c.CreateTag=function(aq,ap){var j=aq.getElementsByTagName("img"),an,am,ao,al;ap=ap||[0,0,0];if(j.length){an=new Image;an.src=j[0].src;am=new O(this,an,aq,ap,0,0);ac(an,j[0],am,this);return am}ao=new L(aq);am=ao.Lines();al=this.textFont||w(Z(aq,"font-family"));if(this.splitWidth){am=ao.SplitWidth(this.splitWidth,this.ctxt,al,this.textHeight)}return new O(this,am,aq,ap,2,this.textHeight+2,this.textColour||Z(aq,"color"),al,ao.original)};c.UpdateTag=function(al,i){var am=this.textColour||Z(i,"color"),j=this.textFont||w(Z(i,"font-family"));al.title=i.title;if(al.colour!=am||al.textFont!=j){al.SetFont(j,am)}};c.Weight=function(am){var al=am.length,j,an,ao=[];for(an=0;an<al;++an){j=C(this,am[an].a);if(j>this.max_weight){this.max_weight=j}if(j<this.min_weight){this.min_weight=j}ao.push(j)}if(this.max_weight>this.min_weight){for(an=0;an<al;++an){am[an].SetWeight(ao[an])}}};c.Load=function(){var ar=this.source.getElementsByTagName("a"),ao=[],aq,an,al,j,i,am,ap={sphere:r,vcylinder:B,hcylinder:Q,vring:z,hring:K};if(ar.length){al=100*this.radiusX;j=100*this.radiusY;i=100*this.radiusZ;this.max_radius=F(al,F(j,i));if(this.shapeArgs){this.shapeArgs[0]=ar.length}else{an=this.shape.toString().split(/[(),]/);aq=an.shift();this.shape=ap[aq]||ap.sphere;this.shapeArgs=[ar.length,al,j,i].concat(an)}am=this.shape.apply(this,this.shapeArgs);this.shuffleTags&&V(am);this.listLength=ar.length;for(af=0;af<ar.length;++af){ao.push(this.CreateTag(ar[af],am[af]))}this.weight&&this.Weight(ao,true)}this.taglist=ao};c.Update=function(){var av=this.source.getElementsByTagName("a"),au=[],ao=this.taglist,aw,at=[],aq=[],am,ar,al,ap,an;if(!this.shapeArgs){return this.Load()}if(av.length){al=this.listLength=av.length;ar=ao.length;for(ap=0;ap<ar;++ap){au.push(ao[ap]);aq.push(ap)}for(ap=0;ap<al;++ap){for(an=0,aw=0;an<ar;++an){if(ao[an].EqualTo(av[ap])){this.UpdateTag(au[an],av[ap]);aw=aq[an]=-1}}if(!aw){at.push(ap)}}for(ap=0,an=0;ap<ar;++ap){if(aq[an]==-1){aq.splice(an,1)}else{++an}}if(aq.length){V(aq);while(aq.length&&at.length){ap=aq.shift();an=at.shift();au[ap]=this.CreateTag(av[an])}aq.sort(function(j,i){return j-i});while(aq.length){au.splice(aq.pop(),1)}}an=au.length/(at.length+1);ap=0;while(at.length){au.splice(P(++ap*an),0,this.CreateTag(av[at.shift()]))}this.shapeArgs[0]=al=au.length;am=this.shape.apply(this,this.shapeArgs);for(ap=0;ap<al;++ap){au[ap].position={x:am[ap][0],y:am[ap][1],z:am[ap][2]}}this.weight&&this.Weight(au)}this.taglist=au};c.SetShadow=function(i){i.shadowBlur=this.shadowBlur;i.shadowOffsetX=this.shadowOffset[0];i.shadowOffsetY=this.shadowOffset[1]};c.Draw=function(av){if(this.paused){return}var ap=this.canvas,an=ap.width,au=ap.height,ax=0,am=(av-this.time)*this.interval/1000,at=an/2+this.offsetX,ar=au/2+this.offsetY,aB=this.ctxt,aq,aC,az,al=-1,ao=this.taglist,ay=ao.length,j=this.frontSelect,aw=(this.centreFunc==R);this.time=av;if(this.frozen&&this.drawn){return this.Animate(an,au,am)}aB.setTransform(1,0,0,1,0,0);this.active=null;for(az=0;az<ay;++az){ao[az].Calc(this.transform)}ao=m(ao,function(aD,i){return i.z-aD.z});for(az=0;az<ay;++az){aC=this.mx>=0&&this.my>=0&&this.taglist[az].CheckActive(aB,at,ar);if(aC&&aC.sc>ax&&(!j||aC.z<=0)){aq=aC;al=az;aq.tag=this.taglist[az];ax=aC.sc}}this.active=aq;this.txtOpt||(this.shadow&&this.SetShadow(aB));aB.clearRect(0,0,an,au);for(az=0;az<ay;++az){if(!aw&&ao[az].z<=0){try{this.centreFunc(aB,an,au,at,ar)}catch(aA){alert(aA);this.centreFunc=R}aw=true}if(!(aq&&aq.tag==ao[az]&&aq.PreDraw(aB,ao[az],at,ar))){ao[az].Draw(aB,at,ar)}aq&&aq.tag==ao[az]&&aq.PostDraw(aB)}if(this.freezeActive&&aq){this.Freeze()}else{this.UnFreeze();this.drawn=(ay==this.listLength)}this.Animate(an,au,am);aq&&aq.LastDraw(aB);ap.style.cursor=aq?this.activeCursor:"";this.Tooltip(aq,this.taglist[al])};c.TooltipNone=function(){};c.TooltipNative=function(j,i){this.canvas.title=j&&i.title?i.title:""};c.TooltipDiv=function(an,j){var i=this,am=i.ttdiv.style,ao=i.canvas.id,al="none";if(an&&j.title){if(j.title!=i.ttdiv.innerHTML){am.display=al}i.ttdiv.innerHTML=j.title;j.title=i.ttdiv.innerHTML;if(am.display==al&&!i.tttimer){i.tttimer=setTimeout(function(){var ap=q(ao);am.display="block";am.left=ap.x+i.mx+"px";am.top=ap.y+i.my+24+"px";i.tttimer=null},i.tooltipDelay)}}else{am.display=al}};c.Transform=function(ao,i,aq){if(i||aq){var j=u(i),ap=k(i),ar=u(aq),an=k(aq),al=new g([an,0,ar,0,0,1,0,0,-ar,0,an,0,0,0,0,1]),am=new g([1,0,0,0,0,ap,-j,0,0,j,ap,0,0,0,0,1]);ao.transform=ao.transform.mul(al.mul(am))}};c.AnimatePosition=function(al,ao,am){var j=this,i=j.mx,aq=j.my,an,ap;if(!j.frozen&&i>=0&&aq>=0&&i<al&&aq<ao){an=j.maxSpeed,ap=j.reverse?-1:1;j.lx||(j.yaw=ap*am*((an*2*i/al)-an));j.ly||(j.pitch=ap*am*-((an*2*aq/ao)-an));j.initial=null}else{if(!j.initial){if(j.frozen&&!j.freezeDecel){j.yaw=j.pitch=0}else{j.Decel(j)}}}this.Transform(j,j.pitch,j.yaw)};c.AnimateDrag=function(j,an,am){var i=this,al=100*am*i.maxSpeed/i.max_radius/i.zoom;if(i.dx||i.dy){i.lx||(i.yaw=i.dx*al/i.stretchX);i.ly||(i.pitch=i.dy*-al/i.stretchY);i.dx=i.dy=0;i.initial=null}else{if(!i.initial){i.Decel(i)}}this.Transform(i,i.pitch,i.yaw)};c.Freeze=function(){if(!this.frozen){this.preFreeze=[this.yaw,this.pitch];this.frozen=1;this.drawn=0}};c.UnFreeze=function(){if(this.frozen){this.yaw=this.preFreeze[0];this.pitch=this.preFreeze[1];this.frozen=0}};c.Decel=function(i){var al=i.minSpeed,am=T(i.yaw),j=T(i.pitch);if(!i.lx&&am>al){i.yaw=am>i.z0?i.yaw*i.decel:0}if(!i.ly&&j>al){i.pitch=j>i.z0?i.pitch*i.decel:0}};c.Zoom=function(i){this.z2=this.z1*(1/i);this.drawn=0};c.Clicked=function(al){var i=this.active;try{i&&i.tag&&i.tag.Clicked(al)}catch(j){}};c.Wheel=function(j){var al=this.zoom+this.zoomStep*(j?1:-1);this.zoom=aj(this.zoomMax,F(this.zoomMin,al));this.Zoom(this.zoom)};c.BeginDrag=function(i){this.down=I(i,this.canvas.id);i.cancelBubble=true;i.returnValue=false;i.preventDefault&&i.preventDefault()};c.Drag=function(an,am){if(this.dragControl&&this.down){var al=this.dragThreshold*this.dragThreshold,j=am.x-this.down.x,i=am.y-this.down.y;if(this.dragging||j*j+i*i>al){this.dx=j;this.dy=i;this.dragging=1;this.down=am}}};c.EndDrag=function(){var i=this.dragging;this.dragging=this.down=null;return i};c.Pause=function(){this.paused=true};c.Resume=function(){this.paused=false};v.Start=function(al,i,j){v.tc[al]=new v(al,i,j)};function ab(i,j){v.tc[j]&&v.tc[j][i]()}v.Pause=function(i){ab("Pause",i)};v.Resume=function(i){ab("Resume",i)};v.Reload=function(i){ab("Load",i)};v.Update=function(i){ab("Update",i)};v.NextFrame=function(i){var j=window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;v.NextFrame=j?v.NextFrameRAF:v.NextFrameTimeout;v.NextFrame(i)};v.NextFrameRAF=function(){requestAnimationFrame(s)};v.NextFrameTimeout=function(i){setTimeout(s,i)};v.tc={};v.options={z1:20000,z2:20000,z0:0.0002,freezeActive:false,freezeDecel:false,activeCursor:"pointer",pulsateTo:1,pulsateTime:3,reverse:false,depth:0.5,maxSpeed:0.05,minSpeed:0,decel:0.95,interval:20,minBrightness:0.1,maxBrightness:1,outlineColour:"#ffff99",outlineThickness:2,outlineOffset:5,outlineMethod:"outline",textColour:"#ff99ff",textHeight:15,textFont:"Helvetica, Arial, sans-serif",shadow:"#000",shadowBlur:0,shadowOffset:[0,0],initial:null,hideTags:true,zoom:1,weight:false,weightMode:"size",weightFrom:null,weightSize:1,weightSizeMin:null,weightSizeMax:null,weightGradient:{0:"#f00",0.33:"#ff0",0.66:"#0f0",1:"#00f"},txtOpt:true,txtScale:2,frontSelect:false,wheelZoom:true,zoomMin:0.3,zoomMax:3,zoomStep:0.05,shape:"sphere",lock:null,tooltip:null,tooltipDelay:300,tooltipClass:"tctooltip",radiusX:1,radiusY:1,radiusZ:1,stretchX:1,stretchY:1,offsetX:0,offsetY:0,shuffleTags:false,noSelect:false,noMouse:false,imageScale:1,paused:false,dragControl:false,dragThreshold:4,centreFunc:R,splitWidth:0};for(af in v.options){v[af]=v.options[af]}window.TagCanvas=v;D("load",function(){v.loaded=1},window)})();
